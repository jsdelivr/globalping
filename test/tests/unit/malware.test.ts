import {readFile, writeFile} from 'node:fs/promises';
import path from 'node:path';
import {expect} from 'chai';
import nock from 'nock';
import {
	sourceList as ipSourceList,
	updateList as ipUpdateList,
	validate as validateIp,
	ipListPath,
} from '../../../src/lib/malware/ip.js';

import {
	sourceList as domainSourceList,
	updateList as domainUpdateList,
	validate as validateDomain,
	domainListPath,
} from '../../../src/lib/malware/domain.js';

const mockDataPath = path.join(path.resolve(), 'test/mocks/malware');

const ipMockResult = await readFile(path.join(mockDataPath, 'nock-ip.txt'), 'utf8');
const domainMockResult = await readFile(path.join(mockDataPath, 'nock-domain.txt'), 'utf8');

describe('malware blacklist', () => {
	describe('ip', () => {
		describe('updateList', () => {
			for (const source of ipSourceList) {
				const url = new URL(source);

				nock(url.origin)
					.get(url.pathname)
					.reply(200, ipMockResult);
			}

			it('should override blacklist file', async () => {
				// Reset the file
				await writeFile(ipListPath, '', {encoding: 'utf8'});

				const preFile = await readFile(ipListPath, 'utf8').catch(() => null);
				await ipUpdateList();
				const postFile = await readFile(ipListPath, 'utf8');

				expect(preFile).to.not.equal(postFile);
			});
		});

		describe('validate', () => {
			it('should fail (ip present on the list)', async () => {
				const isValid = await validateIp('100.0.41.228');

				expect(isValid).to.be.false;
			});

			it('should succeed(ip not on the list)', async () => {
				const isValid = await validateIp('127.0.0.1');

				expect(isValid).to.be.true;
			});
		});
	});

	describe('domain', () => {
		describe('updateList', () => {
			for (const source of domainSourceList) {
				const url = new URL(source);

				nock(url.origin)
					.get(url.pathname)
					.reply(200, domainMockResult);
			}

			it('should override blacklist file', async () => {
				// Reset the file
				await writeFile(domainListPath, '', {encoding: 'utf8'});

				const preFile = await readFile(domainListPath, 'utf8').catch(() => null);
				await domainUpdateList();
				const postFile = await readFile(domainListPath, 'utf8');

				expect(preFile).to.not.equal(postFile);
			});
		});

		describe('validate', () => {
			it('should fail (domain present on the list)', async () => {
				const isValid = await validateDomain('00517985.widget.windsorbongvape.com');

				expect(isValid).to.be.false;
			});

			it('should succeed(domain not on the list)', async () => {
				const isValid = await validateDomain('google.com');

				expect(isValid).to.be.true;
			});
		});
	});
});
